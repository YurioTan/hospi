<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="view_crm_lead2opportunity_partner_inherit_is_from_leads_menu" model="ir.ui.view">
        <field name="name">crm.lead2opportunity.partner.view.form.inherit.is.from.leads.menu</field>
        <field name="model">crm.lead2opportunity.partner</field>
        <field name="inherit_id" ref="crm.view_crm_lead2opportunity_partner"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='lead_id']" position="after">
                <field name="is_from_leads_menu" invisible="1"/>
            </xpath>

            <xpath expr="//field[@name='name']" position="attributes">
                <attribute name="attrs">{'readonly' : [('is_from_leads_menu', '=', True)]}</attribute>
            </xpath>

            <xpath expr="//field[@name='action']" position="attributes">
                <attribute name="attrs">{'readonly' : [('is_from_leads_menu', '=', True)]}</attribute>
            </xpath>

            <xpath expr="//group[2]" position="attributes">
                <attribute name="attrs">{'invisible' : [('is_from_leads_menu', '=', True)]}</attribute>
            </xpath>

            <xpath expr="//field[@name='partner_id']" position="attributes">
                <attribute name="attrs">{'required': [('action', '=', 'exist')], 'invisible':[('action','!=','exist')], 'readonly' : [('is_from_leads_menu', '=', True)]}</attribute>
                <attribute name="options">{'no_create' : True, 'no_open' : True, 'always_reload': True}</attribute>
                <attribute name="context">{'partner_search': True, 'res_partner_search_mode': 'customer', 'show_vat': True}</attribute>
            </xpath>
        </field>
    </record>
    
    <record id="crm_lead_view_tree_custom" model="ir.ui.view">
        <field name="name">crm.lead.view.tree.custom</field>
        <field name="model">crm.lead</field>
        <field name="arch" type="xml">

            <tree string="Leads">
                <field name="create_date" widget="date" optional="hide"/>
                <field name="user_id" widget="many2one_avatar_user" optional="show" domain="[('share', '=', False)]" string="CPM Full Name" />
                <field name="name" string="Funnel Name"/>
                <field name="partner_id" string="End User Name" readonly="1" invisible="1"/>
                <field name="partner_name" string="End User Name"/>
                <field name="distributor_id" readonly="1"/>
                <field name="brand_id" readonly="1" optional="hide"/>
                <field name="product_id" readonly="1" invisible="1"/>
                <field name="product_name"/>
                <field name="product_qty" string="Qty" readonly="1" optional="hide"/>
                <field name="list_price" string="Sales Price" readonly="1" optional="hide" 
                    widget="monetary" options="{'currency_field': 'company_currency', 'field_digits': True}"/>
                <field name="price_subtotal" string="Total" readonly="1" optional="hide"
                    widget="monetary" options="{'currency_field': 'company_currency', 'field_digits': True}"/>
                <field name="e_cat_estimation_date" widget="date" optional="hide"/>
                <field name="installation_estimation_date" widget="date" optional="hide"/>
                <field name="stage_id" string="Funnel Progress"/>
                <field name="probability"/>
                <field name="budget_source_id" readonly="1"/>
                <field name="funnel_status" widget="badge" decoration-success="funnel_status == 'won'" 
                decoration-danger="funnel_status == 'lost'" decoration-warning="funnel_status == 'cancel'" optional="hide"/>
                <field name="lost_reason" readonly="1" optional="hide"/>
                <field name="active" invisible="1"/>
                <field name="company_currency" invisible="1"/>
                <field name="company_id" groups="base.group_multi_company" optional="show"/>
            </tree>
            
        </field>
    </record>

    <record id="crm_lead_view_form_inherit_custom" model="ir.ui.view">
        <field name="name">crm.lead.view.form.inherit</field>
        <field name="model">crm.lead</field>
        <field name="inherit_id" ref="crm.crm_lead_view_form"/>
        <field name="arch" type="xml">

            <xpath expr="//group[1]" position="after">
                <group attrs="{'invisible':[('is_from_leads_menu', '=', False)]}">
                    <group>
                        <field name="is_from_leads_menu" invisible="1"/>
                        <field name="partner_ids" invisible="1"/>
                        <field name="user_id" widget="many2one_avatar_user" force_save="1" readonly="1" 
                            domain="[('share', '=', False)]" string="CPM Full Name" 
                            attrs="{'required': [('is_from_leads_menu', '=', True)]}"/>
                        <field name="partner_id" string="End User" domain="[('id', 'in', partner_ids)]"
                            options="{'no_create' : True, 'no_open' : True, 'always_reload': True}" context="{'partner_search': True}"
                            attrs="{'required': [('is_from_leads_menu', '=', True)]}"/>
                        <field name="distributor_id" options="{'no_create' : True, 'no_open' : True}"
                            attrs="{'required': [('is_from_leads_menu', '=', True)]}"/>
                        <field name="budget_source_id" options="{'no_create' : True, 'no_open' : True}"
                            attrs="{'required': [('is_from_leads_menu', '=', True)]}"/>
                        <field name="e_cat_estimation_date" attrs="{'required': [('is_from_leads_menu', '=', True)]}"/>
                        <field name="installation_estimation_date" attrs="{'required': [('is_from_leads_menu', '=', True)]}"/>
                    </group>
                    <group>
                        <field name="product_ids" invisible="1"/>
                        <field name="company_currency" invisible="1"/>
                        <field name="brand_id" force_save="1" options="{'no_create' : True, 'no_open' : True}"
                            attrs="{'required': [('is_from_leads_menu', '=', True)]}"/>
                        <field name="product_id" force_save="1" context="{'product_search': True}"
                            domain="[('id', 'in', product_ids)]" options="{'no_create' : True, 'no_open' : True, 'always_reload' : True}"
                            attrs="{'required': [('is_from_leads_menu', '=', True)], 'readonly': [('brand_id', '=', False)]}"/>
                        <field name="list_price" string="Product Price" widget="monetary" force_save="1" readonly="1"
                            options="{'currency_field': 'company_currency', 'field_digits': True}"/>
                        <field name="product_qty" attrs="{'required': [('is_from_leads_menu', '=', True)]}"/>
                        <field name="price_subtotal" string="Amount" widget="monetary" force_save="1" readonly="1"
                            options="{'currency_field': 'company_currency', 'field_digits': True}"/>
                        <field name="funnel_status" attrs="{'invisible':[('lost_reason', '=', False)]}"/>
                        <field name="lost_reason" string="Reason" options="{'no_create' : True, 'no_open' : True}"
                            attrs="{'invisible':[('lost_reason', '=', False)]}"/>
                    </group>
                </group>
            </xpath>

            <xpath expr="//div[@class='oe_title']/h2[@class='o_row no-gutters align-items-end']/div[4]" position="attributes">
                <attribute name="attrs">{ 'invisible' : [('is_from_leads_menu', '=', True)] }</attribute>
            </xpath>

            <xpath expr="//div[@class='oe_title']/h2[@class='o_row no-gutters align-items-end']/div[4]" position="after">
                <div class="col" attrs="{ 'invisible' : [('is_from_leads_menu', '=', False)] }">
                    <div class="oe_edit_only d-flex align-items-center">
                        <label for="probability" string="Win Probability"/>
                    </div>
                    <div id="probability" class="o_row d-flex">
                        <field name="is_automated_probability" invisible="1"/>
                        <field name="probability" attrs="{'required': [('is_from_leads_menu', '=', True)]}" widget="float" class="oe_inline"/>
                        <span class="oe_grey"> %</span>
                    </div>
                </div>
            </xpath>

            <xpath expr="//group[1]" position="attributes">
                <attribute name="attrs">{'invisible' : [('is_from_leads_menu', '=', True)]}</attribute>
            </xpath>

            <xpath expr="//button[@name='action_set_won_rainbowman']" position="replace">
                <button name="%(arkana_base_crm.crm_lead_won_reason_action)d" string="Mark Won"
                    type="action" class="oe_highlight" context="{'default_lead_id': active_id, 'default_category_reason': 'won'}" 
                    attrs="{'invisible': ['|','|', ('active','=',False), ('probability', '=', 100), ('type', '=', 'lead')]}"/>
            </xpath>

            <xpath expr="//button[@name='%(crm.crm_lead_lost_action)d']" position="attributes">
                <attribute name="context">{'default_lead_id': active_id, 'default_category_reason': 'lost'}</attribute>
            </xpath>

            <xpath expr="//button[@name='%(crm.crm_lead_lost_action)d']" position="after">
                <button name="%(arkana_base_crm.crm_lead_cancel_reason_action)d" string="Mark Cancel"
                    type="action" class="oe_highlight" context="{'default_lead_id': active_id, 'default_category_reason': 'cancel'}" 
                    attrs="{'invisible': ['|', ('type', '=', 'lead'), '&amp;',('active', '=', False),('probability', '&lt;', 100)]}"/>
            </xpath>
            
        </field>
    </record>

    <record id="crm_lead_custom_view_search" model="ir.ui.view">
        <field name="name">crm.lead.custom.view.search</field>
        <field name="model">crm.lead</field>
        <field name="arch" type="xml">
            <search string="Leads Search">
                <field name="name" string="Lead" filter_domain="['|', ('partner_id', 'ilike', self), ('name', 'ilike', self)]"/>
                <field name="user_id" string="CPM Full Name"/>
                <field name="distributor_id" string="Distributor"/>
                <field name="budget_source_id" string="Budget Source"/>
                <field name="brand_id" string="Brand"/>
                <field name="product_id" string="Product"/>
                <field name="stage_id" domain="[]"/>
                <separator/>
                <filter string="Won" name="won" domain="['&amp;', ('active', '=', True), ('stage_id.is_won', '=', True)]"/>
                <filter string="Lost" name="lost" domain="['&amp;', ('active', '=', False), ('probability', '=', 0)]"/>
                <separator/>
                <filter string="Archived" name="inactive" domain="[('active', '=', False)]"/>
                <group expand="1" string="Group By">
                    <filter string="Salesperson" name="salesperson" context="{'group_by':'user_id'}"/>
                    <filter string="City" name="city" context="{'group_by': 'city'}"/>
                    <filter string="Provinsi" name="country" context="{'group_by':'state_id'}" />
                    <filter string="Distributor" name="distributor" context="{'group_by':'distributor_id'}" />
                    <filter string="Budget" name="budget_source" domain="[]" context="{'group_by':'budget_source_id'}"/>
                    <filter string="Brand" name="brand" domain="[]" context="{'group_by':'brand_id'}"/>
                    <filter string="Product" name="product" domain="[]" context="{'group_by':'product_name'}"/>
                </group>
            </search>
        </field>
    </record>

    <record model="ir.actions.act_window" id="crm_lead_custom_action">
        <field name="name">Leads</field>
        <field name="res_model">crm.lead</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('is_from_leads_menu', '=', True), ('type', '=', 'lead')]</field>
        <field name="search_view_id" ref="crm_lead_custom_view_search"/>
        <field name="context">{
                'default_type' : 'lead',
                'default_is_from_leads_menu' : True,
            }
        </field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a New Lead
            </p>
        </field>
    </record>

    <record id="crm_lead_custom_action_tree" model="ir.actions.act_window.view">
        <field eval="1" name="sequence" />
        <field name="view_mode">tree</field>
        <field name="view_id" ref="crm_lead_view_tree_custom" />
        <field name="act_window_id" ref="crm_lead_custom_action" />
    </record>

    <record id="crm_lead_custom_action_form" model="ir.actions.act_window.view">
        <field eval="2" name="sequence" />
        <field name="view_mode">form</field>
        <field name="view_id" ref="crm_lead_view_form_inherit_custom" />
        <field name="act_window_id" ref="crm_lead_custom_action" />
    </record>

    <record model="ir.actions.act_window" id="crm_opportunity_custom_action">
        <field name="name">Opportunity</field>
        <field name="res_model">crm.lead</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('is_from_leads_menu', '=', True), ('type','=','opportunity')]</field>
        <field name="context">{
                'default_type': 'opportunity',
                'default_is_from_leads_menu' : True,
        }</field>
        <field name="search_view_id" ref="crm_lead_custom_view_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a New Opportunity
            </p>
        </field>
    </record>

    <record id="crm_opportunity_custom_action_tree" model="ir.actions.act_window.view">
        <field eval="1" name="sequence" />
        <field name="view_mode">tree</field>
        <field name="view_id" ref="crm_lead_view_tree_custom" />
        <field name="act_window_id" ref="crm_opportunity_custom_action" />
    </record>

    <record id="crm_opportunity_custom_action_form" model="ir.actions.act_window.view">
        <field eval="2" name="sequence" />
        <field name="view_mode">form</field>
        <field name="view_id" ref="crm_lead_view_form_inherit_custom" />
        <field name="act_window_id" ref="crm_opportunity_custom_action" />
    </record>

</odoo>
